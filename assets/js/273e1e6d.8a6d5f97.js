"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[4798],{861:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>l,default:()=>p,frontMatter:()=>i,metadata:()=>c,toc:()=>d});var o=n(5893),a=n(1151),s=n(5878),r=n(1016);n(4996);const i={},l="Patching Utilities",c={id:"dev/patching-utilities",title:"Patching Utilities",description:"RogueLibs provides several utilities to help you with patching. Whether you use Harmony's attributes, Harmony instances directly, RogueLibs' stuff or something else, is your choice. All of them have their own pros and cons. You can learn more about Harmony here.",source:"@site/docs/dev/patching-utilities.mdx",sourceDirName:"dev",slug:"/dev/patching-utilities",permalink:"/RogueLibs/docs/dev/patching-utilities",draft:!1,unlisted:!1,editUrl:"https://github.com/Chasmical/RogueLibs/edit/main/website/docs/dev/patching-utilities.mdx",tags:[],version:"current",frontMatter:{},sidebar:"documentationSidebar",previous:{title:"Extra Stuff",permalink:"/RogueLibs/docs/dev/extra"},next:{title:"Hooks",permalink:"/RogueLibs/docs/dev/hooks/"}},u={},d=[{value:"<code>RLSetup</code> attribute",id:"rlsetup",level:2},{value:"<code>RoguePatcher</code>",id:"roguepatcher",level:2},{value:"Transpiler helper methods",id:"transpiler-helper-methods",level:2}];function h(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,a.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.h1,{id:"patching-utilities",children:"Patching Utilities"}),"\n",(0,o.jsxs)(t.p,{children:["RogueLibs provides several utilities to help you with patching. Whether you use Harmony's attributes, Harmony instances directly, RogueLibs' stuff or something else, is your choice. All of them have their own pros and cons. You can learn more ",(0,o.jsx)(t.a,{href:"https://harmony.pardeike.net/articles/intro.html",children:"about Harmony here"}),"."]}),"\n","\n","\n",(0,o.jsxs)(t.h2,{id:"rlsetup",children:[(0,o.jsx)(t.code,{children:"RLSetup"})," attribute"]}),"\n",(0,o.jsxs)(t.p,{children:["Since RogueLibs handles custom stuff as classes, you might forget to initialize a new class in your plugin's ",(0,o.jsx)(t.code,{children:"Awake"}),". That's why ",(0,o.jsx)(t.code,{children:"RLSetup"})," attribute is here. You can just add it to a static method, and initialize your custom thing in there."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-csharp",metastring:'title="MyCustomItem.cs"',children:'public class MyCustomItem : CustomItem\n{\n    // highlight-start\n    [RLSetup]\n    public static void Setup()\n    // highlight-end\n    {\n        RogueLibs.CreateCustomItem<MyCustomItem>()\n            .WithName(new CustomNameInfo("Name"))\n            .WithDescription(new CustomNameInfo("Description"))\n            .WithSprite(Properties.Resources.Sprite)\n            .WithUnlock(new ItemUnlock());\n        \n        RogueLibs.CreateCustomName("SomeName", "Dialogue", new CustomNameInfo("Text"));\n    }\n}\n'})}),"\n",(0,o.jsxs)(t.p,{children:["You'll just have to call the following method in your plugin's ",(0,o.jsx)(t.code,{children:"Awake"}),":"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-csharp",metastring:'title="MyCoolPlugin.cs"',children:"    public void Awake()\n    {\n        // highlight-next-line\n        RogueLibs.LoadFromAssembly();\n        /* ... */\n    }\n"})}),"\n",(0,o.jsx)(t.admonition,{title:"Pro-tip",type:"tip",children:(0,o.jsx)(t.p,{children:"Seriously, you should use it. It helps with versioning too. All of the logic in one place."})}),"\n",(0,o.jsx)(t.h2,{id:"roguepatcher",children:(0,o.jsx)(t.code,{children:"RoguePatcher"})}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.code,{children:"RoguePatcher"})," is a small helper class that makes writing patches a little bit faster and easier. If you need more control (patch order, priority, etc.), then you should use the original Harmony methods."]}),"\n",(0,o.jsxs)(s.Z,{defaultValue:"roguepatcher",values:[{label:"RoguePatcher",value:"roguepatcher"},{label:"Harmony",value:"harmony"}],children:[(0,o.jsx)(r.Z,{value:"roguepatcher",children:(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-csharp",children:"RoguePatcher patcher = new RoguePatcher(this);\n\npatcher.Postfix(typeof(StatusEffects), nameof(StatusEffects.hasStatusEffect));\n\npatcher.Postfix(typeof(InvDatabase), nameof(InvDatabase.ChooseArmor), new Type[1] { typeof(string) });\n"})})}),(0,o.jsx)(r.Z,{value:"harmony",children:(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-csharp",children:"Harmony harmony = new Harmony(pluginGUID);\n\nMethodInfo original = AccessTools.Method(typeof(StatusEffects), nameof(StatusEffects.hasStatusEffect));\nMethodInfo patch = AccessTools.Method(GetType(), nameof(MyPatchMethod));\nharmony.Patch(original, new HarmonyMethod(patch));\n\noriginal = AccessTools.Method(typeof(InvDatabase), nameof(InvDatabase.ChooseArmor), new Type[1] { typeof(string) });\npatch = AccessTools.Method(GetType(), nameof(MyPatchMethod2));\nharmony.Patch(original, new HarmonyMethod(patch));\n"})})})]}),"\n",(0,o.jsx)(t.admonition,{title:"Pro-tip",type:"tip",children:(0,o.jsxs)(t.p,{children:["Instead of specifying method names using strings, you should specify them using the ",(0,o.jsx)(t.code,{children:"nameof"})," keyword. Use string names only if the method you're trying to patch is not public."]})}),"\n",(0,o.jsxs)(t.p,{children:["Patch methods should have the following name: ",(0,o.jsx)(t.code,{children:"<TargetType>_<TargetMethod>"}),". In the example above, ",(0,o.jsx)(t.code,{children:"RoguePatcher"})," will search for patch methods called ",(0,o.jsx)(t.code,{children:"StatusEffects_hasStatusEffect"})," and ",(0,o.jsx)(t.code,{children:"InvDatabase_ChooseArmor"})," in your plugin's class."]}),"\n",(0,o.jsx)(t.p,{children:"You can change the type to search patch methods in. Specify it in the constructor or set the property between patches:"}),"\n",(0,o.jsxs)(s.Z,{defaultValue:"roguepatcher",values:[{label:"RoguePatcher",value:"roguepatcher"},{label:"Harmony",value:"harmony"}],children:[(0,o.jsx)(r.Z,{value:"roguepatcher",children:(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-csharp",children:"public class MyCoolPlugin : BaseUnityPlugin\n{\n    public void Awake()\n    {\n        // highlight-next-line\n        RoguePatcher patcher = new RoguePatcher(this, typeof(MyCoolPatches));\n\n        patcher.Postfix(typeof(StatusEffects), nameof(StatusEffects.hasStatusEffect));\n\n        // highlight-next-line\n        patcher.TypeWithPatches = typeof(MyEvenCoolerPatches);\n\n        patcher.Postfix(typeof(InvDatabase), nameof(InvDatabase.ChooseArmor), new Type[1] { typeof(string) });\n    }\n}\npublic class MyCoolPatches\n{\n    public static void StatusEffects_hasStatusEffect(StatusEffects __instance)\n    {\n        /* ... */\n    }\n}\npublic class MyEvenCoolerPatches\n{\n    public static void InvDatabase_ChooseArmor(InvDatabase __instance, string previousArmorName)\n    {\n        /* ... */\n    }\n}\n"})})}),(0,o.jsx)(r.Z,{value:"harmony",children:(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-csharp",children:"public class MyCoolPlugin : BaseUnityPlugin\n{\n    public void Awake()\n    {\n        Harmony harmony = new Harmony(pluginGUID);\n\n        MethodInfo original = AccessTools.Method(typeof(StatusEffects), nameof(StatusEffects.hasStatusEffect));\n        MethodInfo patch = AccessTools.Method(typeof(MyCoolPatches), nameof(MyPatchMethod));\n        harmony.Patch(original, new HarmonyMethod(patch));\n\n        original = AccessTools.Method(typeof(InvDatabase), nameof(InvDatabase.ChooseArmor), new Type[1] { typeof(string) });\n        patch = AccessTools.Method(typeof(MyEvenCoolerPatches), nameof(MyPatchMethod2));\n        harmony.Patch(original, new HarmonyMethod(patch));\n    }\n}\npublic class MyCoolPatches\n{\n    public static void MyPatchMethod(StatusEffects __instance)\n    {\n        /* ... */\n    }\n}\npublic class MyEvenCoolerPatches\n{\n    public static void MyPatchMethod2(InvDatabase __instance, string previousArmorName)\n    {\n        /* ... */\n    }\n}\n"})})})]}),"\n",(0,o.jsx)(t.h2,{id:"transpiler-helper-methods",children:"Transpiler helper methods"}),"\n",(0,o.jsx)(t.p,{children:"Transpilers are kind of complicated, since they use a low-level Intermediate Language (IL) instead of C# (branches, loops and conditions are the hardest part in here). As an example, here's one of the simplest transpilers from RogueLibs:"}),"\n",(0,o.jsxs)(s.Z,{defaultValue:"helper",values:[{label:"Helper methods",value:"helper"},{label:"Harmony",value:"harmony"}],children:[(0,o.jsx)(r.Z,{value:"helper",children:(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-csharp",children:"public static IEnumerable<CodeInstruction> StatusEffects_AddStatusEffect(IEnumerable<CodeInstruction> codeEnumerable)\n    => codeEnumerable.AddRegionAfter(\n        new Func<CodeInstruction, bool>[]\n        {\n            i => i.IsLdloc(),\n            i => i.opcode == OpCodes.Ldarg_3,\n            i => i.opcode == OpCodes.Stfld && i.StoresField(causingAgentField),\n        },\n        new Func<CodeInstruction[], CodeInstruction>[]\n        {\n            a => a[0],\n            _ => new CodeInstruction(OpCodes.Ldarg_0),\n            _ => new CodeInstruction(OpCodes.Call, typeof(RogueLibsPlugin).GetMethod(nameof(SetupEffectHook))),\n        });\n\nprivate static readonly FieldInfo causingAgentField = typeof(StatusEffect).GetField(nameof(StatusEffect.causingAgent));\n"})})}),(0,o.jsxs)(r.Z,{value:"harmony",children:[(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-csharp",children:"public static IEnumerable<CodeInstruction> StatusEffects_AddStatusEffect(IEnumerable<CodeInstruction> code)\n{\n    bool searching = true;\n    int current = 0;\n    CodeInstruction[] matches = new CodeInstruction[after.Length];\n    foreach (CodeInstruction instr in code)\n    {\n        yield return instr;\n        if (searching)\n        {\n            if (current is 0 ? instr.IsLdloc()\n                : current is 1 ? instr.opcode == OpCodes.Ldarg_3\n                : instr.opcode == OpCodes.Stfld && instr.StoresField(causingAgentField))\n            {\n                matches[current] = instr;\n                if (++current is 3)\n                {\n                    searching = false;\n                    yield return matches[0];\n                    yield return new CodeInstruction(OpCodes.Ldarg_0);\n                    yield return new CodeInstruction(OpCodes.Call, typeof(RogueLibsPlugin).GetMethod(nameof(SetupEffectHook)));\n                }\n            }\n            else current = 0;\n        }\n    }\n}\n\nprivate static readonly FieldInfo causingAgentField = typeof(StatusEffect).GetField(nameof(StatusEffect.causingAgent));\n"})}),(0,o.jsx)(t.p,{children:"Yeah, it looks easy. But that's only because it's a very simple example."})]})]}),"\n",(0,o.jsxs)(t.admonition,{title:"Avoid heavy calculations",type:"tip",children:[(0,o.jsxs)(t.p,{children:["When writing predicates, keep in mind that they might get called hundreds or thousands of times. For example, you can pre-calculate the ",(0,o.jsx)(t.code,{children:"FieldInfo"})," value, used by your predicate, just put it in a static readonly field, like in the example above."]}),(0,o.jsxs)(t.p,{children:["Heavy calculations like that can cost you ",(0,o.jsx)(t.strong,{children:"hundreds of milliseconds"})," of start-up time (or even entire seconds, if you're working on a big project)."]})]}),"\n",(0,o.jsx)(t.p,{children:"Here's another example from RogueLibs:"}),"\n",(0,o.jsxs)(s.Z,{defaultValue:"helper",values:[{label:"Helper methods",value:"helper"},{label:"Harmony",value:"harmony"}],children:[(0,o.jsx)(r.Z,{value:"helper",children:(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-csharp",children:'public static IEnumerable<CodeInstruction> Unlocks_LoadInitialUnlocks(IEnumerable<CodeInstruction> codeEnumerable)\n    => codeEnumerable.ReplaceRegion(\n        new Func<CodeInstruction, bool>[]\n        {\n            i => i.opcode == OpCodes.Callvirt && i.Calls(List_Unlock_GetEnumerator),\n            i => i.IsStloc(),\n        },\n        new Func<CodeInstruction, bool>[]\n        {\n            i => i.opcode == OpCodes.Callvirt,\n            i => i.opcode == OpCodes.Endfinally,\n            i => i.opcode == OpCodes.Ldarg_0,\n        },\n        new CodeInstruction[]\n        {\n            new CodeInstruction(OpCodes.Pop),\n            new CodeInstruction(OpCodes.Pop),\n            new CodeInstruction(OpCodes.Call, typeof(RogueLibsPlugin).GetMethod(nameof(LoadUnlockWrappersAndCategorize))),\n        });\n\nprivate static readonly MethodInfo List_Unlock_GetEnumerator = typeof(List<Unlock>).GetMethod("GetEnumerator");\n'})})}),(0,o.jsxs)(r.Z,{value:"harmony",children:[(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-csharp",children:'public static IEnumerable<CodeInstruction> Unlocks_LoadInitialUnlocks(IEnumerable<CodeInstruction> code)\n{\n    int state = 0;\n    int current = 0;\n    CodeInstruction[] beginCache = new CodeInstruction[2];\n    foreach (CodeInstruction instr in code)\n    {\n        if (state is 2)\n            yield return instr;\n        else if (state is 0)\n        {\n            if (current is 0 ? instr.opcode == OpCodes.Callvirt && instr.Calls(List_Unlock_GetEnumerator)\n                : instr.IsStloc())\n            {\n                beginCache[current] = instr;\n                if (++current == 2)\n                {\n                    state = 1;\n                    current = 0;\n                }\n            }\n            else\n            {\n                if (current > 0)\n                {\n                    for (int i = 0; i < current; i++)\n                        yield return beginCache[i];\n                    current = 0;\n                }\n                yield return instr;\n            }\n        }\n        else\n        {\n            if (current is 0 ? instr.opcode == OpCodes.Callvirt\n                : current is 1 ? instr.opcode == OpCodes.Endfinally\n                : instr.opcode == OpCodes.Ldarg_0)\n            {\n                if (++current == 3)\n                {\n                    yield return new CodeInstruction(OpCodes.Pop);\n                    yield return new CodeInstruction(OpCodes.Pop);\n                    yield return new CodeInstruction(OpCodes.Call, typeof(RogueLibsPlugin).GetMethod(nameof(LoadUnlockWrappersAndCategorize)));\n                }\n            }\n            else current = 0;\n        }\n    }\n}\n\nprivate static readonly MethodInfo List_Unlock_GetEnumerator = typeof(List<Unlock>).GetMethod("GetEnumerator");\n'})}),(0,o.jsx)(t.p,{children:"Still relatively simple. I just don't want to spend my time writing a really complicated example."})]})]}),"\n",(0,o.jsx)(t.admonition,{title:"BTHarmonyUtils",type:"info",children:(0,o.jsxs)(t.p,{children:["You might also want to consider using BlazingTwist's ",(0,o.jsx)(t.a,{href:"https://github.com/BlazingTwist/BTHarmonyUtils",children:"BTHarmonyUtils"}),". It provides several useful transpiler-patching utilities, similar to the ones in RogueLibs. It is easier to use, but I don't think there's any documentation on it."]})})]})}function p(e={}){const{wrapper:t}={...(0,a.a)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},1016:(e,t,n)=>{n.d(t,{Z:()=>a});n(7294);var o=n(5893);function a(e){let{children:t,...n}=e;return(0,o.jsx)("div",{role:"tabpanel",...n,children:t})}},5878:(e,t,n)=>{n.d(t,{Z:()=>b});var o=n(7294),a=n(6550),s=n(469),r=n(1980),i=n(7392),l=n(12);function c(e){return function(e){return o.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,o.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:o,default:a}}=e;return{value:t,label:n,attributes:o,default:a}}))}function u(e){const{values:t,children:n}=e;return(0,o.useMemo)((()=>{const e=t??c(n);return function(e){const t=(0,i.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function d(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function h(e){let{queryString:t=!1,groupId:n}=e;const s=(0,a.k6)(),i=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,r._X)(i),(0,o.useCallback)((e=>{if(!i)return;const t=new URLSearchParams(s.location.search);t.set(i,e),s.replace({...s.location,search:t.toString()})}),[i,s])]}function p(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,r=u(e),[i,c]=(0,o.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!d({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const o=n.find((e=>e.default))??n[0];if(!o)throw new Error("Unexpected error: 0 tabValues");return o.value}({defaultValue:t,tabValues:r}))),[p,m]=h({queryString:n,groupId:a}),[f,g]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[a,s]=(0,l.Nk)(n);return[a,(0,o.useCallback)((e=>{n&&s.set(e)}),[n,s])]}({groupId:a}),y=(()=>{const e=p??f;return d({value:e,tabValues:r})?e:null})();(0,s.Z)((()=>{y&&c(y)}),[y]);return{selectedValue:i,selectValue:(0,o.useCallback)((e=>{if(!d({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);c(e),m(e),g(e)}),[m,g,r]),tabValues:r}}var m=n(512);const f={tabItem:"tabItem_V91s",tabItemActive:"tabItemActive_JsUu",blink:"blink_ZPVS",tab:"tab_ntnM"};var g=n(5893);const y={left:37,right:39};function b(e){const{lazy:t,defaultValue:n,values:a,groupId:s}=e,r=o.Children.toArray(e.children),{tabValues:i,selectedValue:l,selectValue:c}=p({children:r,defaultValue:n,values:a,groupId:s}),u=[],d=e=>{const t=e.currentTarget,n=a[u.indexOf(t)].value;c(n),null!=s&&setTimeout((()=>{(function(e){const{top:t,left:n,bottom:o,right:a}=e.getBoundingClientRect(),{innerHeight:s,innerWidth:r}=window;return t>=0&&a<=r&&o<=s&&n>=0})(t)||(t.scrollIntoView({block:"center",behavior:"smooth"}),t.classList.add(f.tabItemActive),setTimeout((()=>t.classList.remove(f.tabItemActive)),2e3))}),150)},h=e=>{let t;switch(e.keyCode){case y.right:{const n=u.indexOf(e.target)+1;t=u[n]||u[0];break}case y.left:{const n=u.indexOf(e.target)-1;t=u[n]||u[u.length-1];break}default:return}t.focus()},b=(e,t)=>t.value===e||t.values&&-1!=t.values.indexOf(e);return(0,g.jsxs)("div",{className:"tabs-container",children:[(0,g.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:"tabs",children:a.map((e=>{let{value:t,label:n}=e;return(0,g.jsx)("li",{role:"tab",tabIndex:l===t?0:-1,"aria-selected":l===t,className:(0,m.Z)("tabs__item",f.tabItem,{"tabs__item--active":l===t}),ref:e=>e&&u.push(e),onKeyDown:h,onFocus:d,onClick:d,children:n},t)}))}),t?o.cloneElement(r.find((e=>b(l,e.props))),{className:f.tab}):(0,g.jsx)("div",{children:r.map(((e,t)=>o.cloneElement(e,{key:t,hidden:!b(l,e.props),className:f.tab})))}),(0,g.jsx)("br",{})]})}},1151:(e,t,n)=>{n.d(t,{Z:()=>i,a:()=>r});var o=n(7294);const a={},s=o.createContext(a);function r(e){const t=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),o.createElement(s.Provider,{value:t},e.children)}}}]);